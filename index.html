<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Chat Teste SignalR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
</head>
<body>
    <h2>Login</h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Senha" />
    <button id="loginBtn">Login</button>

    <h2>Chat</h2>
    <input id="messageInput" placeholder="Digite sua mensagem" />
    <button id="sendBtn">Enviar</button>

    <ul id="messagesList"></ul>

    <script>
        let token = null;
        let connection = null;

        document.getElementById("loginBtn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            try {
                const response = await fetch("https://localhost:5001/api/auth/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) throw new Error("Login falhou");

                const data = await response.json();
                token = data.token;
                alert("Login bem-sucedido!");

                // Conectar SignalR
                connectSignalR();

            } catch (err) {
                alert(err);
            }
        });

        function connectSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:5001/chat", {
                    accessTokenFactory: () => token
                })
                .build();

            connection.on("ReceiveMessage", (userId, message) => {
                const li = document.createElement("li");
                li.textContent = `De ${userId}: ${message}`;
                document.getElementById("messagesList").appendChild(li);
            });

            connection.start()
                .then(() => console.log("Conectado ao SignalR!"))
                .catch(err => console.error(err.toString()));
        }

        document.getElementById("sendBtn").addEventListener("click", async () => {
            const message = document.getElementById("messageInput").value;
            if (!connection) {
                alert("Conecte-se primeiro!");
                return;
            }
            await connection.invoke("SendMessage", message)
                .catch(err => console.error(err.toString()));
        });
    </script>
</body>
</html>
